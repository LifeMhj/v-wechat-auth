/*!
 * v-wechat-auth v1.0.0
 * (c) 2018 fengjun.chen
 * Released under the MIT License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.VWechatAuth=e()}(this,function(){"use strict";var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t,e){return t(e={exports:{}},e.exports),e.exports}var r=e(function(e,r){!function(o){var n=r&&!r.nodeType&&r,s=e&&!e.nodeType&&e,h="object"==typeof t&&t;h.global!==h&&h.window!==h&&h.self!==h||(o=h);var i,a,u=2147483647,c=36,l=1,p=26,f=38,m=700,d=72,v=128,y="-",g=/^xn--/,b=/[^\x20-\x7E]/,w=/[\x2E\u3002\uFF0E\uFF61]/g,j={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},x=c-l,O=Math.floor,q=String.fromCharCode;function A(t){throw RangeError(j[t])}function C(t,e){for(var r=t.length,o=[];r--;)o[r]=e(t[r]);return o}function I(t,e){var r=t.split("@"),o="";return r.length>1&&(o=r[0]+"@",t=r[1]),o+C((t=t.replace(w,".")).split("."),e).join(".")}function U(t){for(var e,r,o=[],n=0,s=t.length;n<s;)(e=t.charCodeAt(n++))>=55296&&e<=56319&&n<s?56320==(64512&(r=t.charCodeAt(n++)))?o.push(((1023&e)<<10)+(1023&r)+65536):(o.push(e),n--):o.push(e);return o}function R(t){return C(t,function(t){var e="";return t>65535&&(e+=q((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+=q(t)}).join("")}function z(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function S(t,e,r){var o=0;for(t=r?O(t/m):t>>1,t+=O(t/e);t>x*p>>1;o+=c)t=O(t/x);return O(o+(x+1)*t/(t+f))}function $(t){var e,r,o,n,s,h,i,a,f,m,g,b=[],w=t.length,j=0,x=v,q=d;for((r=t.lastIndexOf(y))<0&&(r=0),o=0;o<r;++o)t.charCodeAt(o)>=128&&A("not-basic"),b.push(t.charCodeAt(o));for(n=r>0?r+1:0;n<w;){for(s=j,h=1,i=c;n>=w&&A("invalid-input"),((a=(g=t.charCodeAt(n++))-48<10?g-22:g-65<26?g-65:g-97<26?g-97:c)>=c||a>O((u-j)/h))&&A("overflow"),j+=a*h,!(a<(f=i<=q?l:i>=q+p?p:i-q));i+=c)h>O(u/(m=c-f))&&A("overflow"),h*=m;q=S(j-s,e=b.length+1,0==s),O(j/e)>u-x&&A("overflow"),x+=O(j/e),j%=e,b.splice(j++,0,x)}return R(b)}function k(t){var e,r,o,n,s,h,i,a,f,m,g,b,w,j,x,C=[];for(b=(t=U(t)).length,e=v,r=0,s=d,h=0;h<b;++h)(g=t[h])<128&&C.push(q(g));for(o=n=C.length,n&&C.push(y);o<b;){for(i=u,h=0;h<b;++h)(g=t[h])>=e&&g<i&&(i=g);for(i-e>O((u-r)/(w=o+1))&&A("overflow"),r+=(i-e)*w,e=i,h=0;h<b;++h)if((g=t[h])<e&&++r>u&&A("overflow"),g==e){for(a=r,f=c;!(a<(m=f<=s?l:f>=s+p?p:f-s));f+=c)x=a-m,j=c-m,C.push(q(z(m+x%j,0))),a=O(x/j);C.push(q(z(a,0))),s=S(r,w,o==n),r=0,++o}++r,++e}return C.join("")}if(i={version:"1.3.2",ucs2:{decode:U,encode:R},decode:$,encode:k,toASCII:function(t){return I(t,function(t){return b.test(t)?"xn--"+k(t):t})},toUnicode:function(t){return I(t,function(t){return g.test(t)?$(t.slice(4).toLowerCase()):t})}},n&&s)if(e.exports==n)s.exports=i;else for(a in i)i.hasOwnProperty(a)&&(n[a]=i[a]);else o.punycode=i}(t)}),o={isString:function(t){return"string"==typeof t},isObject:function(t){return"object"==typeof t&&null!==t},isNull:function(t){return null===t},isNullOrUndefined:function(t){return null==t}};var n=function(t,e,r,o){e=e||"&",r=r||"=";var n={};if("string"!=typeof t||0===t.length)return n;var s=/\+/g;t=t.split(e);var h=1e3;o&&"number"==typeof o.maxKeys&&(h=o.maxKeys);var i,a,u=t.length;h>0&&u>h&&(u=h);for(var c=0;c<u;++c){var l,p,f,m,d=t[c].replace(s,"%20"),v=d.indexOf(r);v>=0?(l=d.substr(0,v),p=d.substr(v+1)):(l=d,p=""),f=decodeURIComponent(l),m=decodeURIComponent(p),i=n,a=f,Object.prototype.hasOwnProperty.call(i,a)?Array.isArray(n[f])?n[f].push(m):n[f]=[n[f],m]:n[f]=m}return n},s=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}},h=function(t,e,r,o){return e=e||"&",r=r||"=",null===t&&(t=void 0),"object"==typeof t?Object.keys(t).map(function(o){var n=encodeURIComponent(s(o))+r;return Array.isArray(t[o])?t[o].map(function(t){return n+encodeURIComponent(s(t))}).join(e):n+encodeURIComponent(s(t[o]))}).join(e):o?encodeURIComponent(s(o))+r+encodeURIComponent(s(t)):""},i=e(function(t,e){e.decode=e.parse=n,e.encode=e.stringify=h}),a=C,u=function(t,e){return C(t,!1,!0).resolve(e)},c=function(t,e){if(!t)return e;return C(t,!1,!0).resolveObject(e)},l=function(t){o.isString(t)&&(t=C(t));if(!(t instanceof f))return f.prototype.format.call(t);return t.format()},p=f;function f(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var m=/^([a-z0-9.+-]+:)/i,d=/:[0-9]*$/,v=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,y=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),g=["'"].concat(y),b=["%","/","?",";","#"].concat(g),w=["/","?","#"],j=/^[+a-z0-9A-Z_-]{0,63}$/,x=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,O={javascript:!0,"javascript:":!0},q={javascript:!0,"javascript:":!0},A={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function C(t,e,r){if(t&&o.isObject(t)&&t instanceof f)return t;var n=new f;return n.parse(t,e,r),n}f.prototype.parse=function(t,e,n){if(!o.isString(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var s=t.indexOf("?"),h=-1!==s&&s<t.indexOf("#")?"?":"#",a=t.split(h);a[0]=a[0].replace(/\\/g,"/");var u=t=a.join(h);if(u=u.trim(),!n&&1===t.split("#").length){var c=v.exec(u);if(c)return this.path=u,this.href=u,this.pathname=c[1],c[2]?(this.search=c[2],this.query=e?i.parse(this.search.substr(1)):this.search.substr(1)):e&&(this.search="",this.query={}),this}var l=m.exec(u);if(l){var p=(l=l[0]).toLowerCase();this.protocol=p,u=u.substr(l.length)}if(n||l||u.match(/^\/\/[^@\/]+@[^@\/]+/)){var f="//"===u.substr(0,2);!f||l&&q[l]||(u=u.substr(2),this.slashes=!0)}if(!q[l]&&(f||l&&!A[l])){for(var d,y,C=-1,I=0;I<w.length;I++){-1!==(U=u.indexOf(w[I]))&&(-1===C||U<C)&&(C=U)}-1!==(y=-1===C?u.lastIndexOf("@"):u.lastIndexOf("@",C))&&(d=u.slice(0,y),u=u.slice(y+1),this.auth=decodeURIComponent(d)),C=-1;for(I=0;I<b.length;I++){var U;-1!==(U=u.indexOf(b[I]))&&(-1===C||U<C)&&(C=U)}-1===C&&(C=u.length),this.host=u.slice(0,C),u=u.slice(C),this.parseHost(),this.hostname=this.hostname||"";var R="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!R)for(var z=this.hostname.split(/\./),S=(I=0,z.length);I<S;I++){var $=z[I];if($&&!$.match(j)){for(var k="",F=0,N=$.length;F<N;F++)$.charCodeAt(F)>127?k+="x":k+=$[F];if(!k.match(j)){var _=z.slice(0,I),E=z.slice(I+1),P=$.match(x);P&&(_.push(P[1]),E.unshift(P[2])),E.length&&(u="/"+E.join(".")+u),this.hostname=_.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),R||(this.hostname=r.toASCII(this.hostname));var L=this.port?":"+this.port:"",T=this.hostname||"";this.host=T+L,this.href+=this.host,R&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==u[0]&&(u="/"+u))}if(!O[p])for(I=0,S=g.length;I<S;I++){var H=g[I];if(-1!==u.indexOf(H)){var K=encodeURIComponent(H);K===H&&(K=escape(H)),u=u.split(H).join(K)}}var Z=u.indexOf("#");-1!==Z&&(this.hash=u.substr(Z),u=u.slice(0,Z));var M=u.indexOf("?");if(-1!==M?(this.search=u.substr(M),this.query=u.substr(M+1),e&&(this.query=i.parse(this.query)),u=u.slice(0,M)):e&&(this.search="",this.query={}),u&&(this.pathname=u),A[p]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){L=this.pathname||"";var V=this.search||"";this.path=L+V}return this.href=this.format(),this},f.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",r=this.pathname||"",n=this.hash||"",s=!1,h="";this.host?s=t+this.host:this.hostname&&(s=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(s+=":"+this.port)),this.query&&o.isObject(this.query)&&Object.keys(this.query).length&&(h=i.stringify(this.query));var a=this.search||h&&"?"+h||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||A[e])&&!1!==s?(s="//"+(s||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):s||(s=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),e+s+(r=r.replace(/[?#]/g,function(t){return encodeURIComponent(t)}))+(a=a.replace("#","%23"))+n},f.prototype.resolve=function(t){return this.resolveObject(C(t,!1,!0)).format()},f.prototype.resolveObject=function(t){if(o.isString(t)){var e=new f;e.parse(t,!1,!0),t=e}for(var r=new f,n=Object.keys(this),s=0;s<n.length;s++){var h=n[s];r[h]=this[h]}if(r.hash=t.hash,""===t.href)return r.href=r.format(),r;if(t.slashes&&!t.protocol){for(var i=Object.keys(t),a=0;a<i.length;a++){var u=i[a];"protocol"!==u&&(r[u]=t[u])}return A[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(t.protocol&&t.protocol!==r.protocol){if(!A[t.protocol]){for(var c=Object.keys(t),l=0;l<c.length;l++){var p=c[l];r[p]=t[p]}return r.href=r.format(),r}if(r.protocol=t.protocol,t.host||q[t.protocol])r.pathname=t.pathname;else{for(var m=(t.pathname||"").split("/");m.length&&!(t.host=m.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==m[0]&&m.unshift(""),m.length<2&&m.unshift(""),r.pathname=m.join("/")}if(r.search=t.search,r.query=t.query,r.host=t.host||"",r.auth=t.auth,r.hostname=t.hostname||t.host,r.port=t.port,r.pathname||r.search){var d=r.pathname||"",v=r.search||"";r.path=d+v}return r.slashes=r.slashes||t.slashes,r.href=r.format(),r}var y=r.pathname&&"/"===r.pathname.charAt(0),g=t.host||t.pathname&&"/"===t.pathname.charAt(0),b=g||y||r.host&&t.pathname,w=b,j=r.pathname&&r.pathname.split("/")||[],x=(m=t.pathname&&t.pathname.split("/")||[],r.protocol&&!A[r.protocol]);if(x&&(r.hostname="",r.port=null,r.host&&(""===j[0]?j[0]=r.host:j.unshift(r.host)),r.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===m[0]?m[0]=t.host:m.unshift(t.host)),t.host=null),b=b&&(""===m[0]||""===j[0])),g)r.host=t.host||""===t.host?t.host:r.host,r.hostname=t.hostname||""===t.hostname?t.hostname:r.hostname,r.search=t.search,r.query=t.query,j=m;else if(m.length)j||(j=[]),j.pop(),j=j.concat(m),r.search=t.search,r.query=t.query;else if(!o.isNullOrUndefined(t.search)){if(x)r.hostname=r.host=j.shift(),(R=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=R.shift(),r.host=r.hostname=R.shift());return r.search=t.search,r.query=t.query,o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!j.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var O=j.slice(-1)[0],C=(r.host||t.host||j.length>1)&&("."===O||".."===O)||""===O,I=0,U=j.length;U>=0;U--)"."===(O=j[U])?j.splice(U,1):".."===O?(j.splice(U,1),I++):I&&(j.splice(U,1),I--);if(!b&&!w)for(;I--;I)j.unshift("..");!b||""===j[0]||j[0]&&"/"===j[0].charAt(0)||j.unshift(""),C&&"/"!==j.join("/").substr(-1)&&j.push("");var R,z=""===j[0]||j[0]&&"/"===j[0].charAt(0);x&&(r.hostname=r.host=z?"":j.length?j.shift():"",(R=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=R.shift(),r.host=r.hostname=R.shift()));return(b=b||r.host&&j.length)&&!z&&j.unshift(""),j.length?r.pathname=j.join("/"):(r.pathname=null,r.path=null),o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=t.auth||r.auth,r.slashes=r.slashes||t.slashes,r.href=r.format(),r},f.prototype.parseHost=function(){var t=this.host,e=d.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)};var I={parse:a,resolve:u,resolveObject:c,format:l,Url:p};var U="https://github.com/raychenfj/v-wechat-auth",R=["appId","scope","authorize"],z={autoRedirect:!0,state:"",authorize:function(){console.error("should implement authorize method in options")}};function S(t){return t&&"function"==typeof t}var $=function(t){var e=this;this.options=Object.assign(z,t),R.forEach(function(t){e.options[t]||console.error("required property "+t+" is missing in options, please visit "+U+" for more info.")}),this.user=null};return $.prototype.authorize=function(t,e){var r=this,o=I.parse(window.location.href,!0);if(o.query&&!o.query.code)return delete o.query.state,delete o.search,this.redirect(I.format(o));var n=function(e){var o=r.onSuccess(e);return S(t)&&t(o),o},s=function(t){r.onFail(t),S(e)&&e(t)};try{var h=this.options.authorize(o.query.code,n,s);if(h&&h instanceof Promise)return h.then(n).catch(s)}catch(t){s(t)}},$.prototype.onSuccess=function(t){if(!t.openid&&this.options.autoRedirect){var e=I.parse(window.location.href,!0);return delete e.query.code,delete e.query.state,delete e.search,this.redirect(I.format(e))}return this.user=t,this.user},$.prototype.onFail=function(t){console.error("error occurs when authorize from back end"),console.error(t)},$.prototype.redirect=function(t){var e=this.options;window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+e.appId+"&redirect_uri="+encodeURIComponent(t)+"&response_type=code&scope="+e.scope+"&state="+e.state+"#wechat_redirect"},$.install=function t(e,r){t.installed||(t.installed=!0,Object.defineProperty(e.prototype,"$wechatAuth",{get:function(){return this.$root._wechatAuth}}),e.mixin({beforeCreate:function(){this.$options.wechatAuth&&(this._wechatAuth=this.$options.wechatAuth)}}))},$});